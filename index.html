<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neonatología - Hospital Carrillo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/heroicons@2.1.3/24/outline/index.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/heroicons@2.1.3/24/outline/index.js"></script>
    <script type="module">
        // Importar las funciones necesarias de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot,
            getDocs,           // <-- MODIFICADO: Agregado
            getCountFromServer, // <-- MODIFICADO: Agregado
            collection, 
            query,
            where,             // <-- MODIFICADO: Agregado
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARIABLES GLOBALES ---
        let app, auth, db, userId, appId;
        let pacientesCollectionRef, customDiagnosticosCollectionRef;
        
        let filteredPacientes = []; // Pacientes que coinciden con los filtros
        let totalPatientCount = 0; // <-- MODIFICADO: Variable para guardar el conteo total
        let baseDiagnosticos = []; // La lista larga de diagnósticos
        let customDiagnosticos = []; // Diagnósticos agregados por usuarios
        let allDiagnosticos = []; // Lista combinada
        
        let selectedDiagnosticos = []; // Diagnósticos seleccionados en el modal
        let editingPatientId = null; // ID del paciente que se está editando
        let patientToDeleteId = null; // ID del paciente a borrar

        // --- CONFIGURACIÓN DE FIREBASE (¡IMPORTANTE!) ---
        const firebaseConfig = {
            apiKey: "AIzaSyApnwRZQklxTBLhwBBIoyAcCiBAgzyhtvE",
            authDomain: "neomanager-a4482.firebaseapp.com",
            projectId: "neomanager-a4482",
            storageBucket: "neomanager-a4482.firebasestorage.app",
            messagingSenderId: "574188152831",
            appId: "1:574188152831:web:34ab797c5b709e7e3429ca"
        };
        appId = typeof __app_id !== 'undefined' ? __app_id : 'neo-manager-default';
        
        // --- INICIALIZACIÓN DE LA APP ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar Firebase
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug'); // Mostrar logs detallados de Firestore

            // Llenar la lista base de diagnósticos
            populateBaseDiagnosticos();
            
            // Configurar listeners de la UI
            setupUIListeners();
            
            // Iniciar autenticación
            handleAuth();
        });

        // --- MANEJO DE AUTENTICACIÓN Y DATOS ---

        function handleAuth() {
            showLoading(true, "Autenticando...");
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Usuario autenticado:", userId);
                    document.getElementById('user-id-display').textContent = `ID de Usuario: ${userId}`;

                    // Definir rutas de la base de datos (colaborativas)
                    const publicDataPath = `artifacts/${appId}/public/data`;
                    pacientesCollectionRef = collection(db, `${publicDataPath}/pacientes`);
                    customDiagnosticosCollectionRef = collection(db, `${publicDataPath}/diagnosticos_custom`);
                    
                    // Cargar datos
                    loadCustomDiagnosticos(); // Cargar diagnósticos custom
                    updateTotalPatientCount(); // <-- MODIFICADO: Cargar el conteo total
                    
                    showLoading(false);
                    showView('ingreso-view'); // Empezar en la vista de ingreso
                } else {
                    // Si no hay usuario, intentar loguearse
                    try {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error de autenticación:", error);
                        showLoading(false);
                        showToast("Error de autenticación. La app no funcionará.", 'error');
                    }
                }
            });
        }

        /** (NUEVA) Actualiza el contador total de pacientes desde Firestore */
        async function updateTotalPatientCount() {
            try {
                const snapshot = await getCountFromServer(pacientesCollectionRef);
                totalPatientCount = snapshot.data().count;
                // Actualizar el texto en la UI (si la vista de consulta está activa)
                const counterEl = document.getElementById('patient-count');
                if (counterEl && !document.getElementById('consulta-view').classList.contains('hidden')) {
                     // Llama a renderPatientList para actualizar el contador con la data filtrada actual
                     renderPatientList(filteredPacientes, filteredPacientes.length > 0);
                }
